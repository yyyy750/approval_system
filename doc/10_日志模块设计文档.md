# 审批系统 - 日志模块设计文档

## 1. 模块概述

### 1.1 模块定位

日志模块是审批系统的核心基础设施之一，负责记录和追踪系统中发生的所有关键操作，为系统审计、问题排查、安全监控和数据分析提供支撑。

### 1.2 设计目标

| 目标 | 说明 |
|------|------|
| 全面性 | 覆盖所有关键业务操作和系统事件 |
| 可追溯 | 支持按用户、模块、时间等维度追溯操作历史 |
| 高性能 | 日志记录不影响主业务流程的响应性能 |
| 安全性 | 日志数据不可篡改，支持审计合规要求 |
| 易扩展 | 支持灵活添加新的日志类型和字段 |

---

## 2. 数据库设计

### 2.1 操作日志表 (operation_log)

日志模块核心存储表，记录系统操作日志，用于审计追踪。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 日志ID |
| user_id | BIGINT | NOT NULL | - | 操作用户ID |
| module | VARCHAR(50) | NOT NULL | - | 模块名称 |
| operation | VARCHAR(50) | NOT NULL | - | 操作类型 |
| target_id | VARCHAR(36) | - | NULL | 目标业务ID |
| detail | TEXT | - | NULL | 操作详情 |
| ip_address | VARCHAR(50) | - | NULL | 客户端IP地址 |
| user_agent | VARCHAR(500) | - | NULL | 用户代理信息 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**:
- `idx_user_id` (user_id) - 用户操作查询
- `idx_module` (module) - 模块筛选
- `idx_created_at` (created_at) - 时间范围查询

**外键约束**: 
- 无外键约束（与 `sys_user` 无外键关联），确保日志独立性和删除用户后日志仍可保留

### 2.2 建表 SQL

```sql
DROP TABLE IF EXISTS `operation_log`;
CREATE TABLE `operation_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` BIGINT NOT NULL COMMENT '操作用户ID',
  `module` VARCHAR(50) NOT NULL COMMENT '模块名称',
  `operation` VARCHAR(50) NOT NULL COMMENT '操作类型',
  `target_id` VARCHAR(36) DEFAULT NULL COMMENT '目标业务ID',
  `detail` TEXT COMMENT '操作详情',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '客户端IP地址',
  `user_agent` VARCHAR(500) DEFAULT NULL COMMENT '用户代理信息',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_module` (`module`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='操作日志表';
```

---

## 3. 日志分类定义

### 3.1 模块分类 (module)

| 模块编码 | 中文名称 | 说明 |
|----------|----------|------|
| AUTH | 认证模块 | 登录、登出、密码修改等认证相关操作 |
| USER | 用户管理 | 用户账号的增删改查操作 |
| DEPARTMENT | 部门管理 | 部门的增删改查操作 |
| ROLE | 角色管理 | 角色及权限配置操作 |
| APPROVAL | 审批管理 | 审批申请的创建、审批、撤回等操作 |
| WORKFLOW | 工作流管理 | 工作流模板的配置操作 |
| FILE | 文件管理 | 文件上传、下载、删除操作 |
| SYSTEM | 系统配置 | 系统参数配置操作 |

### 3.2 操作类型 (operation)

| 操作编码 | 中文名称 | 适用模块 | 说明 |
|----------|----------|----------|------|
| LOGIN | 登录 | AUTH | 用户登录成功 |
| LOGOUT | 登出 | AUTH | 用户主动登出 |
| LOGIN_FAIL | 登录失败 | AUTH | 登录认证失败 |
| PASSWORD_CHANGE | 密码修改 | AUTH | 用户修改密码 |
| CREATE | 创建 | USER/DEPARTMENT/ROLE/APPROVAL/WORKFLOW | 创建新记录 |
| UPDATE | 更新 | USER/DEPARTMENT/ROLE/APPROVAL/WORKFLOW | 修改现有记录 |
| DELETE | 删除 | USER/DEPARTMENT/ROLE/WORKFLOW | 删除记录 |
| VIEW | 查看 | APPROVAL | 查看敏感详情（可选） |
| SUBMIT | 提交 | APPROVAL | 提交审批申请 |
| APPROVE | 审批通过 | APPROVAL | 审批节点通过 |
| REJECT | 审批拒绝 | APPROVAL | 审批节点拒绝 |
| WITHDRAW | 撤回 | APPROVAL | 撤回审批申请 |
| ASSIGN_ROLE | 分配角色 | USER | 为用户分配角色 |
| UPLOAD | 上传 | FILE | 上传文件 |
| DOWNLOAD | 下载 | FILE | 下载文件 |

---

## 4. 后端实现设计

### 4.1 项目结构

```
backend/src/main/java/com/approval/
├── entity/
│   └── OperationLog.java           # 操作日志实体类
├── mapper/
│   └── OperationLogMapper.java     # 日志数据访问层
├── service/
│   ├── OperationLogService.java    # 日志服务接口
│   └── impl/
│       └── OperationLogServiceImpl.java  # 日志服务实现
├── controller/
│   └── OperationLogController.java # 日志查询接口（管理员）
├── dto/
│   └── OperationLogQueryDTO.java   # 日志查询请求参数
├── vo/
│   └── OperationLogVO.java         # 日志视图对象
├── annotation/
│   └── OperationLog.java           # 操作日志注解（自定义）
├── aspect/
│   └── OperationLogAspect.java     # 操作日志切面
└── enums/
    ├── LogModule.java              # 模块枚举
    └── LogOperation.java           # 操作类型枚举
```

### 4.2 实体类设计

```java
/**
 * 操作日志实体类
 * 记录系统操作日志，用于审计追踪
 */
@Data
@TableName("operation_log")
public class OperationLog {
    
    /** 日志ID */
    @TableId(type = IdType.AUTO)
    private Long id;
    
    /** 操作用户ID */
    private Long userId;
    
    /** 模块名称 */
    private String module;
    
    /** 操作类型 */
    private String operation;
    
    /** 目标业务ID */
    private String targetId;
    
    /** 操作详情 */
    private String detail;
    
    /** 客户端IP地址 */
    private String ipAddress;
    
    /** 用户代理信息 */
    private String userAgent;
    
    /** 创建时间 */
    private LocalDateTime createdAt;
}
```

### 4.3 枚举定义

```java
/**
 * 日志模块枚举
 */
public enum LogModule {
    AUTH("AUTH", "认证模块"),
    USER("USER", "用户管理"),
    DEPARTMENT("DEPARTMENT", "部门管理"),
    ROLE("ROLE", "角色管理"),
    APPROVAL("APPROVAL", "审批管理"),
    WORKFLOW("WORKFLOW", "工作流管理"),
    FILE("FILE", "文件管理"),
    SYSTEM("SYSTEM", "系统配置");
    
    private final String code;
    private final String name;
    
    // 构造函数和getter方法
}

/**
 * 日志操作类型枚举
 */
public enum LogOperation {
    LOGIN("LOGIN", "登录"),
    LOGOUT("LOGOUT", "登出"),
    LOGIN_FAIL("LOGIN_FAIL", "登录失败"),
    PASSWORD_CHANGE("PASSWORD_CHANGE", "密码修改"),
    CREATE("CREATE", "创建"),
    UPDATE("UPDATE", "更新"),
    DELETE("DELETE", "删除"),
    VIEW("VIEW", "查看"),
    SUBMIT("SUBMIT", "提交"),
    APPROVE("APPROVE", "审批通过"),
    REJECT("REJECT", "审批拒绝"),
    WITHDRAW("WITHDRAW", "撤回"),
    ASSIGN_ROLE("ASSIGN_ROLE", "分配角色"),
    UPLOAD("UPLOAD", "上传"),
    DOWNLOAD("DOWNLOAD", "下载");
    
    private final String code;
    private final String name;
    
    // 构造函数和getter方法
}
```

### 4.4 自定义注解

```java
/**
 * 操作日志注解
 * 用于标注需要记录操作日志的方法
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface OperationLog {
    
    /**
     * 模块名称
     */
    LogModule module();
    
    /**
     * 操作类型
     */
    LogOperation operation();
    
    /**
     * 操作描述（支持SpEL表达式）
     */
    String description() default "";
    
    /**
     * 是否记录请求参数
     */
    boolean logParams() default true;
    
    /**
     * 是否记录返回结果
     */
    boolean logResult() default false;
}
```

### 4.5 AOP 切面实现

```java
/**
 * 操作日志切面
 * 自动记录被 @OperationLog 注解标注的方法调用日志
 */
@Aspect
@Component
@Slf4j
public class OperationLogAspect {
    
    @Autowired
    private OperationLogService operationLogService;
    
    @Autowired
    private HttpServletRequest request;
    
    /**
     * 环绕通知，记录操作日志
     */
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint joinPoint, 
                         com.approval.annotation.OperationLog operationLog) 
            throws Throwable {
        
        // 获取当前登录用户ID
        Long userId = SecurityUtils.getCurrentUserId();
        
        // 获取客户端IP
        String ipAddress = getClientIp(request);
        
        // 获取User-Agent
        String userAgent = request.getHeader("User-Agent");
        
        // 构建日志详情
        String detail = buildDetail(joinPoint, operationLog);
        
        // 执行目标方法
        Object result = joinPoint.proceed();
        
        // 异步记录日志
        operationLogService.logAsync(
            userId,
            operationLog.module().getCode(),
            operationLog.operation().getCode(),
            extractTargetId(joinPoint, result),
            detail,
            ipAddress,
            userAgent
        );
        
        return result;
    }
    
    /**
     * 获取客户端真实IP地址
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // 多个代理时取第一个IP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }
}
```

### 4.6 服务层设计

```java
/**
 * 操作日志服务接口
 */
public interface OperationLogService {
    
    /**
     * 记录操作日志
     *
     * [userId] 操作用户ID
     * [module] 模块名称
     * [operation] 操作类型
     * [targetId] 目标业务ID
     * [detail] 操作详情
     * [ipAddress] 客户端IP
     * [userAgent] 用户代理
     */
    void log(Long userId, String module, String operation, 
             String targetId, String detail, 
             String ipAddress, String userAgent);
    
    /**
     * 异步记录操作日志
     */
    @Async
    void logAsync(Long userId, String module, String operation,
                  String targetId, String detail,
                  String ipAddress, String userAgent);
    
    /**
     * 分页查询日志
     *
     * [queryDTO] 查询参数
     * 返回：分页日志列表
     */
    PageResult<OperationLogVO> queryLogs(OperationLogQueryDTO queryDTO);
    
    /**
     * 根据用户ID查询操作日志
     *
     * [userId] 用户ID
     * [page] 页码
     * [pageSize] 每页条数
     * 返回：用户操作日志列表
     */
    PageResult<OperationLogVO> queryByUserId(Long userId, int page, int pageSize);
    
    /**
     * 根据业务ID查询操作日志
     *
     * [targetId] 业务ID
     * 返回：业务相关日志列表
     */
    List<OperationLogVO> queryByTargetId(String targetId);
}
```

---

## 5. API 接口设计

### 5.1 查询操作日志列表

**请求**
```
GET /api/v1/logs?page=1&pageSize=10&module=APPROVAL&userId=1&startTime=2026-01-01&endTime=2026-01-31
Authorization: Bearer {token}
```

**请求参数**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页条数，默认10 |
| module | String | 否 | 模块筛选 |
| operation | String | 否 | 操作类型筛选 |
| userId | Long | 否 | 用户ID筛选 |
| targetId | String | 否 | 目标业务ID |
| startTime | String | 否 | 开始时间（YYYY-MM-DD） |
| endTime | String | 否 | 结束时间（YYYY-MM-DD） |
| keyword | String | 否 | 详情关键词搜索 |

**响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "userId": 1,
        "username": "admin",
        "nickname": "系统管理员",
        "module": "AUTH",
        "moduleName": "认证模块",
        "operation": "LOGIN",
        "operationName": "登录",
        "targetId": null,
        "detail": "用户登录成功",
        "ipAddress": "192.168.1.100",
        "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0",
        "createdAt": "2026-01-15 08:00:00"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "totalPages": 10
  },
  "timestamp": 1705103372000
}
```

### 5.2 获取日志统计信息

**请求**
```
GET /api/v1/logs/statistics?startTime=2026-01-01&endTime=2026-01-31
Authorization: Bearer {token}
```

**响应**
```json
{
  "code": 200,
  "data": {
    "totalCount": 1500,
    "moduleStats": [
      { "module": "AUTH", "moduleName": "认证模块", "count": 500 },
      { "module": "APPROVAL", "moduleName": "审批管理", "count": 400 },
      { "module": "USER", "moduleName": "用户管理", "count": 200 }
    ],
    "operationStats": [
      { "operation": "LOGIN", "operationName": "登录", "count": 450 },
      { "operation": "APPROVE", "operationName": "审批通过", "count": 300 }
    ],
    "dailyStats": [
      { "date": "2026-01-15", "count": 120 },
      { "date": "2026-01-14", "count": 95 }
    ]
  }
}
```

### 5.3 导出操作日志

**请求**
```
GET /api/v1/logs/export?module=APPROVAL&startTime=2026-01-01&endTime=2026-01-31
Authorization: Bearer {token}
```

**响应**
- Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
- Content-Disposition: attachment; filename="operation_logs_20260115.xlsx"

---

## 6. 前端实现设计

### 6.1 页面结构

```
frontend/src/
├── pages/
│   └── admin/
│       └── OperationLogPage.tsx    # 操作日志管理页面
├── services/
│   └── logService.ts               # 日志API服务
├── types/
│   └── log.ts                      # 日志类型定义
└── components/
    └── business/
        └── LogDetailModal.tsx      # 日志详情弹窗
```

### 6.2 类型定义

```typescript
/**
 * 操作日志接口
 */
export interface OperationLog {
  id: number;
  userId: number;
  username: string;
  nickname: string;
  module: string;
  moduleName: string;
  operation: string;
  operationName: string;
  targetId: string | null;
  detail: string;
  ipAddress: string;
  userAgent: string;
  createdAt: string;
}

/**
 * 日志查询参数
 */
export interface LogQueryParams {
  page?: number;
  pageSize?: number;
  module?: string;
  operation?: string;
  userId?: number;
  targetId?: string;
  startTime?: string;
  endTime?: string;
  keyword?: string;
}

/**
 * 日志统计信息
 */
export interface LogStatistics {
  totalCount: number;
  moduleStats: Array<{ module: string; moduleName: string; count: number }>;
  operationStats: Array<{ operation: string; operationName: string; count: number }>;
  dailyStats: Array<{ date: string; count: number }>;
}
```

### 6.3 页面功能

| 功能 | 说明 |
|------|------|
| 日志列表 | 分页展示操作日志，支持多条件筛选 |
| 高级搜索 | 按模块、操作类型、用户、时间范围等组合查询 |
| 日志详情 | 查看单条日志的详细信息 |
| 数据导出 | 支持将筛选结果导出为Excel文件 |
| 统计图表 | 展示日志统计信息（柱状图、饼图等） |

---

## 7. 日志记录最佳实践

### 7.1 使用注解方式记录

```java
/**
 * 创建用户 - 使用注解自动记录日志
 */
@PostMapping
@OperationLog(module = LogModule.USER, operation = LogOperation.CREATE,
              description = "创建用户: #{#request.username}")
public Result<Long> createUser(@RequestBody @Valid UserRequest request) {
    return Result.success(userService.createUser(request));
}
```

### 7.2 手动记录日志

```java
/**
 * 审批操作 - 手动记录日志（需要更复杂的逻辑）
 */
public void approve(String approvalId, boolean approved, String comment) {
    // 执行审批业务逻辑
    approvalService.doApprove(approvalId, approved, comment);
    
    // 手动记录日志
    operationLogService.log(
        SecurityUtils.getCurrentUserId(),
        LogModule.APPROVAL.getCode(),
        approved ? LogOperation.APPROVE.getCode() : LogOperation.REJECT.getCode(),
        approvalId,
        String.format("审批%s: %s", approved ? "通过" : "拒绝", comment),
        RequestUtils.getClientIp(),
        RequestUtils.getUserAgent()
    );
}
```

### 7.3 日志记录原则

| 原则 | 说明 |
|------|------|
| 谁做了什么 | 明确记录操作用户和具体操作 |
| 对什么做的 | 记录操作对象的唯一标识 |
| 什么时候做的 | 自动记录操作时间 |
| 从哪里做的 | 记录客户端IP和设备信息 |
| 结果如何 | 记录操作是否成功及相关详情 |

---

## 8. 日志数据维护

### 8.1 数据归档策略

| 策略 | 配置建议 |
|------|----------|
| 在线保留 | 近3个月日志保留在主表 |
| 归档存储 | 3个月以上日志迁移至归档表 |
| 定期清理 | 超过2年的日志可按需清理 |

### 8.2 归档表设计

```sql
CREATE TABLE `operation_log_archive` (
  -- 结构与 operation_log 相同
  `archive_date` DATE NOT NULL COMMENT '归档日期'
) ENGINE=InnoDB COMMENT='操作日志归档表'
PARTITION BY RANGE (YEAR(archive_date)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p2026 VALUES LESS THAN (2027)
);
```

### 8.3 自动归档任务

```java
/**
 * 日志归档定时任务
 * 每月1日凌晨执行，归档3个月前的日志
 */
@Scheduled(cron = "0 0 2 1 * ?")
public void archiveOldLogs() {
    LocalDateTime threeMonthsAgo = LocalDateTime.now().minusMonths(3);
    operationLogService.archiveBefore(threeMonthsAgo);
    log.info("日志归档完成，归档时间点: {}", threeMonthsAgo);
}
```

---

## 9. 安全与性能考虑

### 9.1 安全措施

| 措施 | 说明 |
|------|------|
| 权限控制 | 仅管理员可访问日志查询接口 |
| 脱敏处理 | 日志详情中敏感信息（密码等）需脱敏 |
| 防篡改 | 日志表仅支持INSERT，不允许UPDATE/DELETE |
| 审计追踪 | 日志查询本身也应记录日志 |

### 9.2 性能优化

| 优化点 | 实现方式 |
|--------|----------|
| 异步写入 | 使用 @Async 或消息队列异步记录日志 |
| 批量插入 | 高频操作可批量写入，减少数据库压力 |
| 索引优化 | 合理设计索引，支持常用查询场景 |
| 分区表 | 按月/按季度分区，提升查询效率 |
| 读写分离 | 日志查询可走从库，减轻主库压力 |

---

## 10. 版本记录

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0.0 | 2026-01-16 | - | 初始版本 |
