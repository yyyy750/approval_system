# 审批系统 - 后端技术实施文档

## 1. 技术概述

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.5.9 | 后端框架 |
| Spring Security | 6.x | 安全框架 |
| MyBatis-Plus | 3.5.5 | ORM 框架 |
| JWT | 0.11.5 | 身份认证 |
| Maven | 3.9.x | 构建工具 |
| Java | 17 | 开发语言 |

## 2. 项目初始化

### 2.1 使用 Spring Initializr 创建项目

访问 https://start.spring.io/ 或使用 IDEA 创建：

- Project: Maven
- Language: Java
- Spring Boot: 3.5.9
- Packaging: Jar
- Java: 17

### 2.2 核心依赖 (pom.xml)

```xml
<dependencies>
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- MyBatis-Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
        <version>3.5.5</version>
    </dependency>
    
    <!-- MySQL Driver -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    
    <!-- JWT -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>0.11.5</version>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    
    <!-- Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
</dependencies>
```

## 3. 项目结构

```
src/main/java/com/approval/
├── ApprovalApplication.java          # 启动类
├── config/                           # 配置类
│   ├── SecurityConfig.java           # 安全配置
│   ├── MybatisPlusConfig.java        # MyBatis-Plus 配置
│   ├── CorsConfig.java               # 跨域配置
│   └── WebMvcConfig.java             # MVC 配置
├── controller/                       # 控制器层
│   ├── AuthController.java           # 认证接口（登录/注册/退出）
│   ├── ApprovalController.java       # 审批接口（创建/审批/撤回）
│   ├── UserController.java           # 用户接口（个人信息/成员管理）
│   ├── FileController.java           # 文件接口（上传/下载/预览）
│   ├── NotificationController.java   # 通知接口（消息列表/标记已读）
│   └── WorkflowController.java       # 工作流接口（模版配置/节点设置）
├── service/                          # 服务层
│   ├── AuthService.java              # 认证服务
│   ├── ApprovalService.java          # 审批业务服务
│   ├── UserService.java              # 用户管理服务
│   ├── FileService.java              # 文件存储服务
│   ├── NotificationService.java      # 消息通知服务
│   ├── WorkflowService.java          # 工作流配置服务
│   └── impl/                         # 服务实现
│       ├── AuthServiceImpl.java
│       ├── ApprovalServiceImpl.java
│       ├── UserServiceImpl.java
│       ├── FileServiceImpl.java
│       ├── NotificationServiceImpl.java
│       └── WorkflowServiceImpl.java
├── mapper/                           # 数据访问层
│   ├── UserMapper.java
│   ├── ApprovalMapper.java
│   ├── ApprovalNodeMapper.java
│   ├── AttachmentMapper.java
│   ├── NotificationMapper.java
│   └── WorkflowTemplateMapper.java
├── entity/                           # 实体类
│   ├── User.java                     # 用户实体
│   ├── Approval.java                 # 审批记录实体
│   ├── ApprovalNode.java             # 审批节点实体
│   ├── Attachment.java               # 附件实体
│   ├── Notification.java             # 通知消息实体
│   └── WorkflowTemplate.java         # 工作流模版实体
├── dto/                              # 数据传输对象（请求）
│   ├── LoginRequest.java             # 登录请求
│   ├── RegisterRequest.java          # 注册请求
│   ├── PasswordUpdateRequest.java    # 密码更新请求
│   ├── ApprovalRequest.java          # 创建/更新审批请求
│   ├── ApproveActionRequest.java     # 审批操作请求（通过/拒绝）
│   └── WorkflowTemplateRequest.java  # 工作流模版请求
├── vo/                               # 视图对象（响应）
│   ├── UserVO.java                   # 用户视图
│   ├── ApprovalVO.java               # 审批视图
│   ├── ApprovalDetailVO.java         # 审批详情视图
│   ├── NotificationVO.java           # 通知视图
│   └── WorkflowTemplateVO.java       # 工作流模版视图
├── common/                           # 公共模块
│   ├── Result.java                   # 统一响应
│   ├── PageResult.java               # 分页响应
│   └── ErrorCode.java                # 错误码枚举
├── exception/                        # 异常处理
│   ├── BusinessException.java        # 业务异常
│   └── GlobalExceptionHandler.java   # 全局异常处理器
├── security/                         # 安全模块
│   ├── JwtTokenProvider.java         # JWT Token 工具
│   └── JwtAuthenticationFilter.java  # JWT 认证过滤器
└── util/                             # 工具类
    ├── FileUtil.java                 # 文件操作工具
    └── DateUtil.java                 # 日期处理工具
```

## 4. 核心配置

### 4.1 应用配置 (application.yml)

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/approval_system?useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# JWT 配置
jwt:
  secret: your-256-bit-secret-key-here
  expiration: 86400000  # 24小时

# 文件上传配置
file:
  upload-dir: D:/uploads/approval-system
  access-path: /files
```

### 4.2 统一响应类 (Result.java)

```java
/**
 * 统一响应结果类
 * @param <T> 响应数据类型
 */
@Data
@Builder
public class Result<T> {
    /** 状态码 */
    private Integer code;
    /** 消息 */
    private String message;
    /** 数据 */
    private T data;
    /** 时间戳 */
    private Long timestamp;

    public static <T> Result<T> success(T data) {
        return Result.<T>builder()
                .code(200)
                .message("success")
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }

    public static <T> Result<T> error(Integer code, String message) {
        return Result.<T>builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
}
```

### 4.3 分页响应类 (PageResult.java)

```java
/**
 * 分页响应结果类
 * 字段与前端 PaginatedData 类型保持一致
 * 
 * @param <T> 列表项类型
 */
@Data
@Builder
public class PageResult<T> {
    /** 数据列表 */
    private List<T> list;
    /** 总条数 */
    private Long total;
    /** 当前页码 */
    private Integer page;
    /** 每页条数 */
    private Integer pageSize;
    /** 总页数 */
    private Integer totalPages;

    /**
     * 从 MyBatis-Plus IPage 构建分页结果
     * 
     * @param page IPage 分页对象
     * @return PageResult 分页响应
     */
    public static <T> PageResult<T> of(IPage<T> page) {
        return PageResult.<T>builder()
                .list(page.getRecords())
                .total(page.getTotal())
                .page((int) page.getCurrent())
                .pageSize((int) page.getSize())
                .totalPages((int) page.getPages())
                .build();
    }
}
```

### 4.4 全局异常处理

```java
/**
 * 全局异常处理器
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<?> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));
        return Result.error(400, message);
    }

    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.error(500, "服务器内部错误");
    }
}
```

## 5. 安全配置

### 5.1 Security 配置

```java
/**
 * Spring Security 配置类
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(cors -> cors.configure(http))
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/files/**").permitAll()
                .anyRequest().authenticated())
            .addFilterBefore(jwtAuthenticationFilter, 
                UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 5.2 JWT Token 工具类

```java
/**
 * JWT Token 提供者
 */
@Component
public class JwtTokenProvider {

    @Value("${jwt.secret}")
    private String jwtSecret;

    @Value("${jwt.expiration}")
    private long jwtExpiration;

    /**
     * 生成 JWT Token
     * @param userId 用户ID
     * @return token 字符串
     */
    public String generateToken(Long userId) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpiration);

        return Jwts.builder()
                .setSubject(String.valueOf(userId))
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                .compact();
    }

    /**
     * 从 Token 中获取用户ID
     */
    public Long getUserIdFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                .build()
                .parseClaimsJws(token)
                .getBody();
        return Long.valueOf(claims.getSubject());
    }

    /**
     * 验证 Token 是否有效
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                    .setSigningKey(Keys.hmacShaKeyFor(jwtSecret.getBytes()))
                    .build()
                    .parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }
}
```

## 6. 开发命令

```bash
# 运行项目
mvn spring-boot:run

# 打包
mvn clean package -DskipTests

# 运行打包后的 jar
java -jar target/approval-system-1.0.0.jar
```
